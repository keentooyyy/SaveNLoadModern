name: Cleanup Old Docker Images

on:
  workflow_dispatch:  # Manual trigger only

env:
  PACKAGE_NAME: savenloadmodern
  PACKAGE_OWNER: keentooyyy
  # Always keeps: latest, prod-latest, main, and version tags (v*)
  # Deletes: All dev-* tags (including dev-latest), old commit-based prod-* versions, and untagged versions older than 7 days (sha256 digests)

jobs:
  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Get all package versions
        id: get-versions
        run: |
          echo "Fetching all package versions..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions" \
            --jq '.[] | "\(.id)|\(.metadata.container.tags | join(","))|\(.created_at)"' > /tmp/all_versions.txt || echo ""
          
          echo "Found versions:"
          cat /tmp/all_versions.txt | head -20 || echo "No versions found"

      - name: Cleanup old versions
        run: |
          DELETED_COUNT=0
          KEPT_COUNT=0
          
          # Calculate cutoff date (7 days ago) - grace period for untagged versions
          # This prevents breaking Docker clients with cached manifest references
          CUTOFF_DATE=$(date -u -d '7 days ago' +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "Processing versions..."
          echo "Grace period: Untagged versions newer than $CUTOFF_DATE will be kept"
          
          # Process each version
          while IFS='|' read -r version_id tags created_at; do
            if [ -z "$version_id" ]; then
              continue
            fi
            
            # Check if this version has any special tags we always keep
            KEEP_THIS=false
            
            # Check for dev-* tags - delete ALL of them (dev is local only)
            if echo "$tags" | grep -qiE "dev-"; then
              echo "Deleting: $tags (dev build - local only)"
              if gh api \
                -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                DELETED_COUNT=$((DELETED_COUNT + 1))
                echo "  Deleted successfully"
              else
                echo "  Failed to delete (may have been deleted already)"
              fi
              continue
            fi
            
            # Check for special tags: latest, prod-latest, main (but NOT dev-latest)
            if echo "$tags" | grep -qiE "(latest|main)" && ! echo "$tags" | grep -qiE "dev-"; then
              KEEP_THIS=true
              echo "Keeping: $tags (special tag)"
              KEPT_COUNT=$((KEPT_COUNT + 1))
            # Check for version tags (v1.0.0, v2.0, etc.)
            elif echo "$tags" | grep -qE "v[0-9]+\.[0-9]+"; then
              KEEP_THIS=true
              echo "Keeping: $tags (version tag)"
              KEPT_COUNT=$((KEPT_COUNT + 1))
            fi
            
            # If not keeping, check if it's a commit-based tag or untagged version to delete
            if [ "$KEEP_THIS" = false ]; then
              # Check if tags is empty (untagged version - sha256 digest only)
              if [ -z "$tags" ] || [ "$tags" = "" ]; then
                # Check if this untagged version is within grace period
                # This prevents breaking Docker clients with cached manifest references
                # Convert dates to epoch for reliable comparison
                CREATED_EPOCH=$(date -d "$created_at" +%s 2>/dev/null || echo "0")
                CUTOFF_EPOCH=$(date -d "$CUTOFF_DATE" +%s 2>/dev/null || echo "0")
                if [ "$CREATED_EPOCH" -gt "$CUTOFF_EPOCH" ]; then
                  echo "Keeping: (untagged version - within 7 day grace period, created: $created_at)"
                  KEPT_COUNT=$((KEPT_COUNT + 1))
                else
                  echo "Deleting: (untagged version - older than 7 days, created: $created_at)"
                  if gh api \
                    -X DELETE \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                    DELETED_COUNT=$((DELETED_COUNT + 1))
                    echo "  Deleted successfully"
                  else
                    echo "  Failed to delete (may have been deleted already)"
                  fi
                fi
              # Check if it's a commit-based prod-* tag (not prod-latest)
              elif echo "$tags" | grep -qE "prod-[a-f0-9]"; then
                # Delete old commit-based prod versions (not tagged as prod-latest)
                echo "Deleting: $tags (old commit-based prod version)"
                if gh api \
                  -X DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                  echo "  Deleted successfully"
                else
                  echo "  Failed to delete (may have been deleted already)"
                fi
              else
                # Unknown tag type, keep it to be safe
                echo "Keeping: $tags (unknown type - keeping for safety)"
                KEPT_COUNT=$((KEPT_COUNT + 1))
              fi
            fi
          done < /tmp/all_versions.txt
          
          echo ""
          echo "========================================="
          echo "Cleanup Summary:"
          echo "  Kept: $KEPT_COUNT versions"
          echo "  Deleted: $DELETED_COUNT versions"
          echo "========================================="

      - name: Summary
        run: |
          echo "## Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Old Docker image versions have been cleaned up automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policy:**" >> $GITHUB_STEP_SUMMARY
          echo "- Always keep: \`latest\`, \`prod-latest\`, \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "- Always keep: Version tags (\`v*\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Delete ALL dev builds (\`dev-*\` including \`dev-latest\` - dev is local only)" >> $GITHUB_STEP_SUMMARY
          echo "- Delete all old commit-based prod versions (\`prod-*\` that aren't tagged as prod-latest)" >> $GITHUB_STEP_SUMMARY
          echo "- Delete untagged versions older than 7 days (grace period for cached manifests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Packages](https://github.com/${{ github.repository }}/pkgs/container/${{ env.PACKAGE_OWNER }}/${{ env.PACKAGE_NAME }})" >> $GITHUB_STEP_SUMMARY

