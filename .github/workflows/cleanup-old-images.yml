name: Cleanup Old Docker Images

on:
  workflow_dispatch:  # Manual trigger only

env:
  PACKAGE_NAME: savenloadmodern
  PACKAGE_OWNER: keentooyyy
  # Always keeps: latest, prod-latest, main, and version tags (v*)
  # Deletes: All dev-* tags (including dev-latest), old commit-based prod-* versions, and untagged versions older than 7 days (sha256 digests)

jobs:
  cleanup:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Get all package versions
        id: get-versions
        run: |
          echo "Fetching all package versions..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions" \
            --jq '.[] | "\(.id)|\(.metadata.container.tags | join(","))|\(.created_at)"' > /tmp/all_versions.txt || echo ""
          
          echo "Found versions:"
          cat /tmp/all_versions.txt | head -20 || echo "No versions found"

      - name: Cleanup old versions
        run: |
          DELETED_COUNT=0
          KEPT_COUNT=0
          
          # Calculate cutoff date (7 days ago) - grace period for untagged versions
          # This prevents breaking Docker clients with cached manifest references
          CUTOFF_DATE=$(date -u -d '7 days ago' +"%Y-%m-%dT%H:%M:%SZ")
          CUTOFF_EPOCH=$(date -d "$CUTOFF_DATE" +%s 2>/dev/null || echo "0")
          
          echo "Processing versions..."
          echo "Grace period: Untagged versions newer than $CUTOFF_DATE will be kept"
          echo "Additionally: Most recent untagged version will always be kept (prevents breaking cached pulls)"
          
          # First pass: collect all untagged versions to find the most recent one
          echo "Collecting untagged versions..."
          UNTAGGED_FILE=$(mktemp)
          while IFS='|' read -r version_id tags created_at; do
            if [ -z "$version_id" ]; then
              continue
            fi
            if [ -z "$tags" ] || [ "$tags" = "" ]; then
              CREATED_EPOCH=$(date -d "$created_at" +%s 2>/dev/null || echo "0")
              echo "$version_id|$created_at|$CREATED_EPOCH" >> "$UNTAGGED_FILE"
            fi
          done < /tmp/all_versions.txt
          
          # Find the most recent untagged version (highest epoch)
          MOST_RECENT_UNTAGGED_ID=""
          MOST_RECENT_EPOCH=0
          if [ -s "$UNTAGGED_FILE" ]; then
            while IFS='|' read -r version_id created_at epoch; do
              if [ "$epoch" -gt "$MOST_RECENT_EPOCH" ]; then
                MOST_RECENT_EPOCH=$epoch
                MOST_RECENT_UNTAGGED_ID=$version_id
              fi
            done < "$UNTAGGED_FILE"
            if [ -n "$MOST_RECENT_UNTAGGED_ID" ]; then
              echo "Most recent untagged version ID: $MOST_RECENT_UNTAGGED_ID (epoch: $MOST_RECENT_EPOCH)"
            fi
          fi
          
          # Process each version
          while IFS='|' read -r version_id tags created_at; do
            if [ -z "$version_id" ]; then
              continue
            fi
            
            # Check if this version has any special tags we always keep
            KEEP_THIS=false
            
            # Check for dev-* tags - delete ALL of them (dev is local only)
            if echo "$tags" | grep -qiE "dev-"; then
              echo "Deleting: $tags (dev build - local only)"
              if gh api \
                -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                DELETED_COUNT=$((DELETED_COUNT + 1))
                echo "  Deleted successfully"
              else
                echo "  Failed to delete (may have been deleted already)"
              fi
              continue
            fi
            
            # Check for special tags: latest, prod-latest, main (but NOT dev-latest)
            if echo "$tags" | grep -qiE "(latest|main)" && ! echo "$tags" | grep -qiE "dev-"; then
              KEEP_THIS=true
              echo "Keeping: $tags (special tag)"
              KEPT_COUNT=$((KEPT_COUNT + 1))
            # Check for version tags (v1.0.0, v2.0, etc.)
            elif echo "$tags" | grep -qE "v[0-9]+\.[0-9]+"; then
              KEEP_THIS=true
              echo "Keeping: $tags (version tag)"
              KEPT_COUNT=$((KEPT_COUNT + 1))
            fi
            
            # If not keeping, check if it's a commit-based tag or untagged version to delete
            if [ "$KEEP_THIS" = false ]; then
              # Check if tags is empty (untagged version - sha256 digest only)
              if [ -z "$tags" ] || [ "$tags" = "" ]; then
                # Always keep the most recent untagged version (prevents breaking cached pulls)
                # This is the version that was previously tagged as 'latest' before a new push
                if [ "$version_id" = "$MOST_RECENT_UNTAGGED_ID" ]; then
                  echo "Keeping: (untagged version - most recent, always kept to prevent breaking cached pulls, created: $created_at)"
                  KEPT_COUNT=$((KEPT_COUNT + 1))
                else
                  # For other untagged versions, check if within grace period
                  CREATED_EPOCH=$(date -d "$created_at" +%s 2>/dev/null || echo "0")
                  if [ "$CREATED_EPOCH" -gt "$CUTOFF_EPOCH" ]; then
                    echo "Keeping: (untagged version - within 7 day grace period, created: $created_at)"
                    KEPT_COUNT=$((KEPT_COUNT + 1))
                  else
                    echo "Deleting: (untagged version - older than 7 days and not most recent, created: $created_at)"
                    if gh api \
                      -X DELETE \
                      -H "Accept: application/vnd.github+json" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                      DELETED_COUNT=$((DELETED_COUNT + 1))
                      echo "  Deleted successfully"
                    else
                      echo "  Failed to delete (may have been deleted already)"
                    fi
                  fi
                fi
              # Check if it's a commit-based prod-* tag (not prod-latest)
              elif echo "$tags" | grep -qE "prod-[a-f0-9]"; then
                # Delete old commit-based prod versions (not tagged as prod-latest)
                echo "Deleting: $tags (old commit-based prod version)"
                if gh api \
                  -X DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/users/${{ env.PACKAGE_OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/$version_id" 2>/dev/null; then
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                  echo "  Deleted successfully"
                else
                  echo "  Failed to delete (may have been deleted already)"
                fi
              else
                # Unknown tag type, keep it to be safe
                echo "Keeping: $tags (unknown type - keeping for safety)"
                KEPT_COUNT=$((KEPT_COUNT + 1))
              fi
            fi
          done < /tmp/all_versions.txt
          
          # Cleanup temp file
          rm -f "$UNTAGGED_FILE"
          
          echo ""
          echo "========================================="
          echo "Cleanup Summary:"
          echo "  Kept: $KEPT_COUNT versions"
          echo "  Deleted: $DELETED_COUNT versions"
          echo "========================================="

