import{c as a,o as r,r as U,g as u,A as L,j as T,B as E,x as p,d as I,e as N,i as k,k as A,l as B,b as e,s as S,F as P,D as M,t as C,L as j,n as D,Q as F,z as $}from"./islands-CvRdAtFP.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as z,g as O}from"./wsToken-mbUjdKxf.js";const V={},Y={class:"min-vh-100 w-100"};function G(i,c){return r(),a("div",Y,[U(i.$slots,"default")])}const J=q(V,[["render",G]]),Q=i=>{const c=u([]),b=u(!1),y=u(""),m=u(!0);let n=null,l=null,h=!1,w=!0;const f=async()=>i.getWsToken?i.getWsToken():O(),_=()=>{w=!1,l&&(window.clearTimeout(l),l=null),n&&(n.close(),n=null)},W=g=>{try{const o=JSON.parse(g.data);o.type==="workers_update"&&(c.value=Array.isArray(o.payload?.workers)?o.payload?.workers??[]:[])}catch(o){console.error("Workers WS message error:",o)}},v=async()=>{if(!window.WebSocket){m.value=!1;return}if(!i.userRef?.value)return;const g=await f();if(!g)return;l&&(window.clearTimeout(l),l=null);const o=z("/ws/ui/workers/",{token:g});n=new WebSocket(o),n.addEventListener("open",()=>{b.value=!0,h=!0}),n.addEventListener("message",W),n.addEventListener("close",()=>{if(b.value=!1,i.reloadOnClose&&h){p.flashWarning("Worker connection lost. Reloading..."),window.location.reload();return}w&&(l=window.setTimeout(v,3e3))}),n.addEventListener("error",x=>{y.value="Workers socket error",console.error("Workers WS error:",x),n?.close()})};return L(v),T(()=>i.userRef?.value,()=>{!n&&i.userRef?.value&&v()}),E(_),{workers:c,socketOpen:b,lastError:y,supportsWebSocket:m}},H={key:0,class:"container d-flex align-items-center justify-content-center",style:{"min-height":"80vh"}},K={key:1,class:"container d-flex align-items-center justify-content-center",style:{"min-height":"80vh"}},X={class:"text-center w-100",style:{"max-width":"600px"}},Z={key:0,class:"card bg-dark border-secondary"},ee={class:"list-group list-group-flush"},se={class:"text-start"},te={class:"text-white d-block"},ne={class:"mt-1"},re={key:0,class:"badge bg-warning text-dark ms-2"},ae={key:1,class:"badge bg-secondary ms-2"},le=["disabled","onClick"],oe={key:1,class:"text-muted"},ie={key:1,class:"card bg-dark border-secondary p-4 text-center"},ce="/static/images/icon.png",de=I({__name:"WorkerRequiredPage",setup(i){const c=N(),{workers:b}=Q({reloadOnClose:!1,userRef:k(()=>c.user),getWsToken:()=>O()}),y=u(!0),m=u(null),n=u(!1),l=u(!1),h=u(null),w=t=>t.online!==!1,f=k(()=>b.value.filter(t=>w(t))),_=k(()=>f.value.length>0),W=k(()=>f.value.filter(t=>!t.claimed)),v=k(()=>{const t=c.user?.username;return t&&f.value.find(s=>s.claimed&&s.linked_user===t)||null}),g=k(()=>{const t=h.value;return t&&f.value.find(s=>s.client_id===t&&s.claimed)||null}),o=()=>{l.value||(v.value||g.value)&&(l.value=!0,window.location.assign("/dashboard"))},x=async t=>{if(!m.value)try{m.value=t;const s=await F("/client/claim/",{client_id:t});s?.message&&p.flashSuccess(s.message);try{window.localStorage.setItem("savenload_client_id",t)}catch{}window.location.assign("/dashboard")}catch(s){s?.message&&p.error(s.message)}finally{m.value=null}},R=()=>{p.flashInfo("Refreshing worker list..."),window.location.reload()};return T(W,t=>{t.length===1&&!n.value?n.value=!0:t.length!==1&&(n.value=!1)}),L(async()=>{try{if(await c.refreshUser(),!c.user){window.location.assign("/login");return}try{h.value=window.localStorage.getItem("savenload_client_id")}catch{h.value=null}o()}catch{window.location.assign("/login");return}finally{y.value=!1}}),T([v,g],()=>{o()}),(t,s)=>(r(),A(J,null,{default:B(()=>[y.value?(r(),a("div",H,[...s[0]||(s[0]=[e("div",{class:"text-center"},[e("div",{class:"spinner-border text-white",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")]),e("p",{class:"text-white-50 mt-3 mb-0"},"Checking session...")],-1)])])):(r(),a("div",K,[e("div",X,[e("div",{class:"mb-4"},[e("img",{src:ce,alt:"Worker Missing",width:"80",height:"80"})]),s[5]||(s[5]=e("h2",{class:"text-white mb-3"},"Worker Missing",-1)),s[6]||(s[6]=e("p",{class:"text-white-50 mb-4"},"To use the application you need to have a client worker running.",-1)),s[7]||(s[7]=e("div",{class:"p-3 mb-4 rounded d-flex align-items-start bg-primary bg-opacity-10 border border-primary text-white"},[e("i",{class:"fas fa-info-circle me-3 mt-1 fs-5"}),e("div",null,[e("strong",null,"Tip:"),S(" The correct Worker ID contains your PC name + a unique code."),e("br"),S(" Example: "),e("code",null,"YOUR-PC-NAME_a1:b2:c3:d4:e5:f6")])],-1)),_.value?(r(),a("div",Z,[s[2]||(s[2]=e("div",{class:"card-header border-secondary"},[e("h5",{class:"mb-0 text-white"},"Online Workers")],-1)),e("div",ee,[(r(!0),a(P,null,M(f.value,d=>(r(),a("div",{key:d.client_id,class:"list-group-item bg-dark border-secondary d-flex justify-content-between align-items-center"},[e("div",se,[e("strong",te,"Worker ID: "+C(d.client_id),1),e("div",ne,[s[1]||(s[1]=e("span",{class:"badge bg-success"},"Online",-1)),d.claimed?(r(),a("span",re," Claimed by: "+C(d.linked_user===j(c).user?.username?"You":d.linked_user||"Unknown"),1)):(r(),a("span",ae,"Unclaimed"))])]),d.claimed?(r(),a("span",oe,"Already claimed")):(r(),a("button",{key:0,class:"btn btn-primary btn-sm claim-btn",disabled:m.value===d.client_id,onClick:ue=>x(d.client_id)},C(m.value===d.client_id?"CONNECTING...":"Use Worker"),9,le))]))),128))])])):(r(),a("div",ie,[...s[3]||(s[3]=[e("div",{class:"mb-3"},[e("div",{class:"spinner-border text-white",role:"status",style:{width:"3rem",height:"3rem"}},[e("span",{class:"visually-hidden"},"Loading...")])],-1),e("h5",{class:"text-white mb-2"},"Searching for Workers",-1),e("p",{class:"text-white-50 mb-0"},"Please ensure the SaveNLoad client is running on your PC.",-1)])])),e("button",{class:D(["btn btn-outline-light mt-3",{"d-none":_.value}]),type:"button",onClick:R},[...s[4]||(s[4]=[e("i",{class:"fas fa-sync-alt me-2"},null,-1),S("Refresh List ",-1)])],2)])]))]),_:1}))}});$("worker-required",de);
