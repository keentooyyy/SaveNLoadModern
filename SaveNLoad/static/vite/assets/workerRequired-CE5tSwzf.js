import{c as a,o as r,r as U,g as m,A as L,j as C,B as E,x as p,d as I,e as O,i as y,k as N,l as A,b as e,s as x,F as B,D as P,P as T,t as S,n as M,Q as j,z as D}from"./islands-BZEcu5Tg.js";import{_ as F}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as $,g as R}from"./wsToken-Bm8pUQB5.js";const q={},z={class:"min-vh-100 w-100"};function V(o,i){return r(),a("div",z,[U(o.$slots,"default")])}const Y=F(q,[["render",V]]),G=o=>{const i=m([]),c=m(!1),k=m(""),f=m(!0);let n=null,l=null,g=!1,b=!0;const W=async()=>o.getWsToken?o.getWsToken():R(),w=()=>{b=!1,l&&(window.clearTimeout(l),l=null),n&&(n.close(),n=null)},_=v=>{try{const d=JSON.parse(v.data);d.type==="workers_update"&&(i.value=Array.isArray(d.payload?.workers)?d.payload?.workers??[]:[])}catch(d){console.error("Workers WS message error:",d)}},h=async()=>{if(!window.WebSocket){f.value=!1;return}if(!o.userRef?.value)return;const v=await W();if(!v)return;l&&(window.clearTimeout(l),l=null);const d=$("/ws/ui/workers/",{token:v});n=new WebSocket(d),n.addEventListener("open",()=>{c.value=!0,g=!0}),n.addEventListener("message",_),n.addEventListener("close",()=>{if(c.value=!1,o.reloadOnClose&&g){p.flashWarning("Worker connection lost. Reloading..."),window.location.reload();return}b&&(l=window.setTimeout(h,3e3))}),n.addEventListener("error",t=>{k.value="Workers socket error",console.error("Workers WS error:",t),n?.close()})};return L(h),C(()=>o.userRef?.value,()=>{!n&&o.userRef?.value&&h()}),E(w),{workers:i,socketOpen:c,lastError:k,supportsWebSocket:f}},J={key:0,class:"container d-flex align-items-center justify-content-center",style:{"min-height":"80vh"}},Q={key:1,class:"container d-flex align-items-center justify-content-center",style:{"min-height":"80vh"}},H={class:"text-center w-100",style:{"max-width":"600px"}},K={key:0,class:"card bg-dark border-secondary"},X={class:"list-group list-group-flush"},Z={class:"text-start"},ee={class:"text-white d-block"},se={class:"mt-1"},te={key:0,class:"badge bg-warning text-dark ms-2"},ne={key:1,class:"badge bg-secondary ms-2"},re=["disabled","onClick"],ae={key:1,class:"text-muted"},le={key:1,class:"card bg-dark border-secondary p-4 text-center"},oe="/static/images/icon.png",ie=I({__name:"WorkerRequiredPage",setup(o){const i=O(),{workers:c}=G({reloadOnClose:!1,userRef:y(()=>i.user),getWsToken:()=>R()}),k=m(!0),f=m(null),n=m(!1),l=m(!1),g=m(null),b=y(()=>c.value.length>0),W=y(()=>c.value.filter(t=>!t.claimed)),w=y(()=>{const t=i.user?.username;return t&&c.value.find(s=>s.claimed&&s.linked_user===t)||null}),_=y(()=>{const t=g.value;return t&&c.value.find(s=>s.client_id===t&&s.claimed)||null}),h=()=>{l.value||(w.value||_.value)&&(l.value=!0,window.location.assign("/dashboard"))},v=async t=>{if(!f.value)try{f.value=t;const s=await j("/client/claim/",{client_id:t});s?.message&&p.flashSuccess(s.message);try{window.localStorage.setItem("savenload_client_id",t)}catch{}window.location.assign("/dashboard")}catch(s){s?.message&&p.error(s.message)}finally{f.value=null}},d=()=>{p.flashInfo("Refreshing worker list..."),window.location.reload()};return C(W,t=>{t.length===1&&!n.value?n.value=!0:t.length!==1&&(n.value=!1)}),L(async()=>{try{if(await i.refreshUser(),!i.user){window.location.assign("/login");return}try{g.value=window.localStorage.getItem("savenload_client_id")}catch{g.value=null}h()}catch{window.location.assign("/login");return}finally{k.value=!1}}),C([w,_],()=>{h()}),(t,s)=>(r(),N(Y,null,{default:A(()=>[k.value?(r(),a("div",J,[...s[0]||(s[0]=[e("div",{class:"text-center"},[e("div",{class:"spinner-border text-white",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")]),e("p",{class:"text-white-50 mt-3 mb-0"},"Checking session...")],-1)])])):(r(),a("div",Q,[e("div",H,[e("div",{class:"mb-4"},[e("img",{src:oe,alt:"Worker Missing",width:"80",height:"80"})]),s[5]||(s[5]=e("h2",{class:"text-white mb-3"},"Worker Missing",-1)),s[6]||(s[6]=e("p",{class:"text-white-50 mb-4"},"To use the application you need to have a client worker running.",-1)),s[7]||(s[7]=e("div",{class:"p-3 mb-4 rounded d-flex align-items-start bg-primary bg-opacity-10 border border-primary text-white"},[e("i",{class:"fas fa-info-circle me-3 mt-1 fs-5"}),e("div",null,[e("strong",null,"Tip:"),x(" The correct Worker ID contains your PC name + a unique code."),e("br"),x(" Example: "),e("code",null,"YOUR-PC-NAME_a1:b2:c3:d4:e5:f6")])],-1)),b.value?(r(),a("div",K,[s[2]||(s[2]=e("div",{class:"card-header border-secondary"},[e("h5",{class:"mb-0 text-white"},"Online Workers")],-1)),e("div",X,[(r(!0),a(B,null,P(T(c),u=>(r(),a("div",{key:u.client_id,class:"list-group-item bg-dark border-secondary d-flex justify-content-between align-items-center"},[e("div",Z,[e("strong",ee,"Worker ID: "+S(u.client_id),1),e("div",se,[s[1]||(s[1]=e("span",{class:"badge bg-success"},"Online",-1)),u.claimed?(r(),a("span",te," Claimed by: "+S(u.linked_user===T(i).user?.username?"You":u.linked_user||"Unknown"),1)):(r(),a("span",ne,"Unclaimed"))])]),u.claimed?(r(),a("span",ae,"Already claimed")):(r(),a("button",{key:0,class:"btn btn-primary btn-sm claim-btn",disabled:f.value===u.client_id,onClick:ce=>v(u.client_id)},S(f.value===u.client_id?"CONNECTING...":"Use Worker"),9,re))]))),128))])])):(r(),a("div",le,[...s[3]||(s[3]=[e("div",{class:"mb-3"},[e("div",{class:"spinner-border text-white",role:"status",style:{width:"3rem",height:"3rem"}},[e("span",{class:"visually-hidden"},"Loading...")])],-1),e("h5",{class:"text-white mb-2"},"Searching for Workers",-1),e("p",{class:"text-white-50 mb-0"},"Please ensure the SaveNLoad client is running on your PC.",-1)])])),e("button",{class:M(["btn btn-outline-light mt-3",{"d-none":b.value}]),type:"button",onClick:d},[...s[4]||(s[4]=[e("i",{class:"fas fa-sync-alt me-2"},null,-1),x("Refresh List ",-1)])],2)])]))]),_:1}))}});D("worker-required",ie);
